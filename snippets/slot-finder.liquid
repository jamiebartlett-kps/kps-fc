<div class="flex flex-col gap-8">
  <h3 class="!italic typography--h8 text-center">
    Find out your delivery day<br>
    to start shopping...
  </h3>
  <form id="postcode-form" class="flex flex-col items-center gap-8">
    <div class="w-full">
      <label htmlFor="postcode-input" class="block typography--body-sm">Postcode</label>
      <input
        type="text"
        id="postcode-input"
        name="postcode"
        placeholder="e.g., SW1A 1AA"
        required
        class="border w-full border-gray-400 p-2 bg-gray-100 rounded-sm"
      >
    </div>
    <button
      type="submit"
      class="button button--secondary !bg-[#a30062] hover:!bg-[#c20075] !text-white"
    >
      Show my delivery day
    </button>
    <p>Or <span class="underline">sign in</span> to your account</p>
  </form>

  {%- if modal -%}
    <button
      id="slot-finder-close-x"
      style="position:absolute; top:10px; right:10px; font-size:1.5em; background:none; border:none; cursor:pointer;"
    >
      &times;
    </button>
    <button id="slot-finder-close-btn" class="button button--secondary button--full-width" style="margin-top:1em;">
      Close
    </button>
  {%- endif -%}
</div>

<!-- Hidden modal-opener that targets #FormResponseModal -->
<modal-opener data-modal="#SlotFinder" aria-hidden="true" style="display:none">
  <button id="OpenSlotFiner" type="button" aria-controls="SlotFinder" aria-expanded="false"></button>
</modal-opener>

<script
  type="text/javascript"
>
  const modal = document.querySelector('#SlotFinder');
  const closeBtn = document.getElementById('slot-finder-close-x');
  document.getElementById('postcode-form').addEventListener('submit', async function (e) {
    e.preventDefault();

    const postcode = document.getElementById('postcode-input').value.trim();
    const resultsDiv = document.getElementById('slot-results');
    const openerBtn = document.querySelector('#OpenSlotFiner');

    try {
      const response = await fetch(`/apps/slot/slotFinder?postcode=${encodeURIComponent(postcode)}`);
      if (!response.ok) throw new Error('Network response was not ok');
      const data = await response.json();

      if (!Array.isArray(data) || data.length === 0) {
        modal.querySelector('.js-empty-state').classList.remove('hidden');
        modal.querySelector('.js-empty-state').classList.add('flex');
        openerBtn.click();
        return;
      } else {
        modal.querySelector('.js-empty-state').classList.add('hidden');
        modal.querySelector('.js-empty-state').classList.remove('flex');
      }

      let tableHTML = `
          <div class="relative w-full flex justify-center">
            <img
              class=""
              src="{{ 'sign-up--postcode-box.webp' | asset_url }}"
              alt="{{ product.title | escape }}"
              width="430"
              height="430"
              loading="lazy"
              decoding="async"
            >
            <div class="typography--h1 text-center text-white p-2.5 absolute left-1/2 -translate-x-1/2 whitespace-nowrap top-1/2 translate-y-[25%] -rotate-[5deg]" style="background-image: url('{{ 'home--black-band.webp' | asset_url }}');">Available Slots (${data.length})</div>
          </div>
          <table class="slots-table text-left table-auto border-spacing-2">
            <thead>
              <tr>
                <th class="px-2">Day</th>
                <th class="px-2">Time</th>
                <th class="px-2">Partner</th>
                <th class="px-2">Contact</th>
                <th class="px-2">Action</th>
              </tr>
            </thead>
            <tbody>`;

      tableHTML += data
        .map(
          (slot, idx) => `
          <tr class="border-b border-gray-300 last:border-b-0">
            <td class="py-4 px-2">${slot.day}</td>
            <td class="py-4 px-2">${slot.timeWindow}</td>
            <td class="py-4 px-2">${slot.partner?.name || 'N/A'}</td>
            <td class="py-4 px-2">${slot.partner?.contactEmail || 'N/A'}</td>
            <td class="py-4 px-2"><button type="button" class="select-button button button--secondary !bg-[#f3f3f3] hover:!bg-[#e0e0e0]" data-slot-id="${
              slot.id
            }">Select</button></td>
          </tr>
        `
        )
        .join('');

      tableHTML += `</tbody></table>`;
      resultsDiv.innerHTML = tableHTML;

      resultsDiv.querySelectorAll('.select-button').forEach((btn) => {
        btn.addEventListener('click', function () {
          const slotId = this.getAttribute('data-slot-id');
          console.log('[v0] Selected slot:', data[slotId]);
        });
      });

      resultsDiv.querySelectorAll('.select-button').forEach((btn) => {
        btn.addEventListener('click', async function () {
          const slotId = this.getAttribute('data-slot-id');
          try {
            await fetch('/cart/update.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ attributes: { delivery_slot_id: slotId } }),
            });
            closeModal();
          } catch (err) {
            alert('Failed to add slot to cart.');
          }
        });
      });
    } catch (err) {
      resultsDiv.innerHTML = '<div class="error-state">Error fetching slots. Please try again.</div>';
    }
    openerBtn.click();
  });

  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('pointer-events-none')) {
      closeModal();
    }
  });

  function closeModal() {
    modal.removeAttribute('open');
    document.body.classList.remove('overflow-hidden');
  }
</script>
