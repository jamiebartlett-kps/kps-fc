<div class="flex flex-col gap-8">
  {% if cart.attributes.delivery_slot_id != blank %}
    {% if cart.items != empty %}
      <h3 class="typography--h2 text-center">Your order</h3>
      <div class="bg-[#f2ede3] px-10 py-5 flex flex-col text-center">
        <h3 class="typography--h6">Delivery slot details:</h3>
        <p>
          {{ cart.attributes.delivery_slot_postcode }}
        </p>
        <p>
          <span class="capitalize">
            {{ cart.attributes.delivery_slot_day }}
          </span>
          - {{ cart.attributes.delivery_slot_time }}
        </p>
        <p>
          {{ cart.attributes.delivery_slot_partner }}
        </p>
      </div>
      {% for item in cart.items %}
        <div class="flex gap-x-4">
          <img
            src="{{ item.image | img_url: '100x100' }}"
            alt="{{ item.title }}"
            class="cart-item-thumbnail"
            width="100"
            height="100"
          >
          <div class="flex-1 flex flex-col">
            <p>{{ item.title }}</p>
            <p>Qty: {{ item.quantity }}</p>
            <p>{{ item.final_line_price | money }}</p>
          </div>
        </div>
      {% endfor %}
      <div class="flex flex-col border-y border-gray-300 py-6 mb-6">
        <div class="flex">
          <div>Subtotal:</div>
          <div class="ml-auto">{{ cart.items_subtotal_price | money }}</div>
        </div>
        <div class="flex">
          <div>Delivery:</div>
          <div class="ml-auto">Free Total</div>
        </div>
        <div class="flex typography--body-lg font-bold">
          <div>Toal:</div>
          <div class="ml-auto">{{ cart.total_price | money }}</div>
        </div>
      </div>

    {% else %}
      <div class="flex flex-col">
        <div class="relative w-full flex flex-col justify-center">
          <img
            class=""
            src="{{ 'sign-up--postcode-box.webp' | asset_url }}"
            alt="{{ cart.attributes.delivery_slot_day }}"
            width="430"
            height="430"
            loading="lazy"
            decoding="async"
          >
          <div
            class="typography--h3 text-center text-white p-2.5 absolute left-1/5 -translate-x-1/5 whitespace-nowrap top-1/2 translate-y-[-20%] -rotate-[2deg] px-10 capitalize"
            style="background-image: url('{{ 'home--black-band.webp' | asset_url }}');"
          >
            {{ cart.attributes.delivery_slot_day }}
          </div>
          <div
            class="typography--h6 text-center text-white p-2.5 absolute left-3/4 -translate-x-3/4 whitespace-nowrap top-1/2 translate-y-[100%] px-5"
            style="background-image: url('{{ 'home--black-band.webp' | asset_url }}');"
          >
            is your delivery day!
          </div>
        </div>
        <div class="bg-[#f2ede3] px-10 py-5 flex flex-col text-center">
          <h3 class="typography--h6">Delivery slot details:</h3>
          <p>
            {{ cart.attributes.delivery_slot_postcode }}
          </p>
          <p>
            <span class="capitalize">
              {{ cart.attributes.delivery_slot_day }}
            </span>
            - {{ cart.attributes.delivery_slot_time }}
          </p>
          <p>
            {{ cart.attributes.delivery_slot_partner }}
          </p>
        </div>
      </div>
    {%- endif -%}

  {% else %}
    <div id="js-no-results" class="flex flex-col gap-8">
      <h3 class="!italic typography--h8 text-center">
        {% if block.settings.title != blank %}
          {{ block.settings.title }}
        {% endif %}
      </h3>
      <form id="postcode-form" class="flex flex-col items-center gap-8">
        <div class="w-full">
          <label htmlFor="postcode-input" class="block typography--body-sm">Postcode</label>
          <input
            type="text"
            id="postcode-input"
            name="postcode"
            placeholder="e.g., SW1A 1AA"
            required
            class="border w-full border-gray-400 p-2 bg-gray-100 rounded-sm"
          >
        </div>
        <button
          type="submit"
          class="button button--secondary !bg-[#a30062] hover:!bg-[#c20075] !text-white"
        >
          Show my delivery day
        </button>
        <p>Or <span class="underline">sign in</span> to your account</p>
      </form>
    </div>
  {%- endif -%}
</div>

<!-- Hidden modal-opener that targets #FormResponseModal -->
<modal-opener data-modal="#SlotFinder" aria-hidden="true" style="display:none">
  <button id="OpenSlotFiner" type="button" aria-controls="SlotFinder" aria-expanded="false"></button>
</modal-opener>

<script
  type="text/javascript"
>
  const modal = document.querySelector('#SlotFinder');
  const closeBtn = document.getElementById('slot-finder-close-x');
  document.getElementById('postcode-form').addEventListener('submit', async function (e) {
    e.preventDefault();

    const postcode = document.getElementById('postcode-input').value.trim();
    const resultsDiv = document.getElementById('slot-results');
    const openerBtn = document.querySelector('#OpenSlotFiner');
    const noResultContainer = document.querySelector('#js-no-results');

    try {
      const response = await fetch(`/apps/slot/slotFinder?postcode=${encodeURIComponent(postcode)}`);
      if (!response.ok) throw new Error('Network response was not ok');
      const data = await response.json();

      if (!Array.isArray(data) || data.length === 0) {
        modal.querySelector('.js-empty-state').classList.remove('hidden');
        modal.querySelector('.js-empty-state').classList.add('flex');
        openerBtn.click();
        return;
      } else {
        modal.querySelector('.js-empty-state').classList.add('hidden');
        modal.querySelector('.js-empty-state').classList.remove('flex');
      }

      let tableHTML = `
          <div class="relative w-full flex justify-center">
            <img
              class=""
              src="{{ 'sign-up--postcode-box.webp' | asset_url }}"
              alt="{{ product.title | escape }}"
              width="430"
              height="430"
              loading="lazy"
              decoding="async"
            >
            <div class="typography--h1 text-center text-white p-2.5 absolute left-1/2 -translate-x-1/2 whitespace-nowrap top-1/2 translate-y-[25%] -rotate-[5deg]" style="background-image: url('{{ 'home--black-band.webp' | asset_url }}');">Available Slots (${data.length})</div>
          </div>
          <table class="slots-table text-left table-auto border-spacing-2">
            <thead>
              <tr>
                <th class="px-2">Day</th>
                <th class="px-2">Time</th>
                <th class="px-2">Partner</th>
                <th class="px-2">Contact</th>
                <th class="px-2">Action</th>
              </tr>
            </thead>
            <tbody>`;

      tableHTML += data
        .map(
          (slot, idx) => `
          <tr class="border-b border-gray-300 last:border-b-0">
            <td class="py-4 px-2">${slot.day}</td>
            <td class="py-4 px-2">${slot.timeWindow}</td>
            <td class="py-4 px-2">${slot.partner?.name || 'N/A'}</td>
            <td class="py-4 px-2">${slot.partner?.contactEmail || 'N/A'}</td>
            <td class="py-4 px-2"><button type="button" class="select-button button button--secondary !bg-[#f3f3f3] hover:!bg-[#e0e0e0]" data-slot-id="${
              slot.id
            }"
            data-slot-day="${slot.day}"
            data-slot-timewindow="${slot.timeWindow}"
            data-slot-partner="${slot.partner?.name || 'N/A'}"
            data-slot-partneremail="${slot.partner?.contactEmail || 'N/A'}"
            data-slot-postcode="${postcode}"
            >Select</button></td>
          </tr>
        `
        )
        .join('');

      tableHTML += `</tbody></table>`;
      resultsDiv.innerHTML = tableHTML;

      resultsDiv.querySelectorAll('.select-button').forEach((btn) => {
        btn.addEventListener('click', function () {
          const slotId = this.getAttribute('data-slot-id');
          console.log('[v0] Selected slot:', data[slotId]);
        });
      });

      resultsDiv.querySelectorAll('.select-button').forEach((btn) => {
        btn.addEventListener('click', async function () {
          const slotDay = this.getAttribute('data-slot-day');
          const slotTime = this.getAttribute('data-slot-timewindow');
          const slotParner = this.getAttribute('data-slot-partner');
          const slotParneremail = this.getAttribute('data-slot-partneremail');
          const slotpostcode = this.getAttribute('data-slot-postcode');
          const slotId = this.getAttribute('data-slot-id');
          try {
            const response = await fetch('/cart/update.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                attributes: {
                  delivery_slot_id: slotId,
                  delivery_slot_day: slotDay,
                  delivery_slot_time: slotTime,
                  delivery_slot_partner: slotParner,
                  delivery_slot_partneremail: slotParneremail,
                  delivery_slot_postcode: postcode,
                },
              }),
            });
            const data = await response.json();

            // Log the response data
            console.log('Cart update response:', data);

            if (data.items.length === 0) {
              noResultContainer.innerHTML = `
                <div class="flex flex-col">
                  <div class="relative w-full flex flex-col justify-center">
                    <img
                      class=""
                      src="{{ 'sign-up--postcode-box.webp' | asset_url }}"
                      alt="{{ data.attributes.delivery_slot_day }}"
                      width="430"
                      height="430"
                      loading="lazy"
                      decoding="async"
                    >
                    <div
                      class="typography--h3 text-center text-white p-2.5 absolute left-1/5 -translate-x-1/5 whitespace-nowrap top-1/2 translate-y-[-20%] -rotate-[2deg] px-10 capitalize"
                      style="background-image: url('{{ 'home--black-band.webp' | asset_url }}');"
                    >
                      ${data.attributes.delivery_slot_day}
                    </div>
                    <div
                      class="typography--h6 text-center text-white p-2.5 absolute left-3/4 -translate-x-3/4 whitespace-nowrap top-1/2 translate-y-[100%] px-5"
                      style="background-image: url('{{ 'home--black-band.webp' | asset_url }}');"
                    >
                      is your delivery day!
                    </div>
                  </div>
                  <div class="bg-[#f2ede3] px-10 py-5 flex flex-col text-center">
                    <h3 class="typography--h6">Delivery slot details:</h3>
                    <p>
                      ${data.attributes.delivery_slot_postcode}
                    </p>
                    <p>
                      <span class="capitalize">
                        ${data.attributes.delivery_slot_day}
                      </span>
                      - ${data.attributes.delivery_slot_time}
                    </p>
                    <p>
                      ${data.attributes.delivery_slot_partner}
                    </p>
                  </div>
                </div>
              `;
            } else {
              noResultContainer.innerHTML = `
                <h3 class="typography--h2 text-center">Your order</h3>
                <div class="bg-[#f2ede3] px-10 py-5 flex flex-col text-center">
                  <h3 class="typography--h6">Delivery slot details:</h3>
                  <p>
                    ${data.attributes.delivery_slot_postcode}
                  </p>
                  <p>
                    <span class="capitalize">
                      ${data.attributes.delivery_slot_day}
                    </span>
                    - ${data.attributes.delivery_slot_time}
                  </p>
                  <p>
                    ${data.attributes.delivery_slot_partner}
                  </p>
                </div>
                ${data.items
                  .map(
                    (item) => `
                  <div class="flex gap-x-4">
                    <img
                      src="${item.image}" 
                      alt="${item.title}"
                      class="cart-item-thumbnail"
                      width="100"
                      height="100"
                    >
                    <div class="flex-1 flex flex-col">
                      <p>${item.title}</p>
                      <p>Qty: ${item.quantity}</p>
                      <p>${(item.final_line_price / 100).toLocaleString('en-GB', {
                        style: 'currency',
                        currency: 'GBP',
                      })}</p>
                    </div>
                  </div>
                `
                  )
                  .join('')}
                <div class="flex flex-col border-y border-gray-300 py-6 mb-6">
                  <div class="flex">
                    <div>Subtotal:</div>
                    <div class="ml-auto">${(data.items_subtotal_price / 100).toLocaleString('en-GB', {
                      style: 'currency',
                      currency: 'GBP',
                    })}</div>
                  </div>
                  <div class="flex">
                    <div>Delivery:</div>
                    <div class="ml-auto">Free Total</div>
                  </div>
                  <div class="flex typography--body-lg font-bold">
                    <div>Total:</div>
                    <div class="ml-auto">${(data.total_price / 100).toLocaleString('en-GB', {
                      style: 'currency',
                      currency: 'GBP',
                    })}</div>
                  </div>
                </div>
              `;
            }

            closeModal();
          } catch (err) {
            alert('Failed to add slot to cart.');
          }
        });
      });
    } catch (err) {
      resultsDiv.innerHTML = '<div class="error-state">Error fetching slots. Please try again.</div>';
    }
    openerBtn.click();
  });

  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('pointer-events-none')) {
      closeModal();
    }
  });

  function closeModal() {
    modal.removeAttribute('open');
    document.body.classList.remove('overflow-hidden');
  }
</script>
